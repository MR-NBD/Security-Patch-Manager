# Security Patch Manager (SPM) - Schema a Blocchi Architetturale

## 1. HIGH-LEVEL ARCHITECTURE OVERVIEW

```
                                    INTERNET
                                       │
          ┌────────────────────────────┼────────────────────────────┐
          │                            │                            │
          ▼                            ▼                            ▼
    ┌───────────┐              ┌───────────┐               ┌───────────┐
    │    USN    │              │    DSA    │               │    NVD    │
    │  Ubuntu   │              │  Debian   │               │   NIST    │
    │  Security │              │  Security │               │   CVE DB  │
    └─────┬─────┘              └─────┬─────┘               └─────┬─────┘
          │                          │                           │
          │  RSS/JSON                │  HTML Scraping            │  REST API
          │                          │                           │
          └──────────────────────────┼───────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     AZURE TENANT MASTER (HUB) - italynorth                  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        PUBLIC CONTAINER (ACI)                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │           SPM API v2.6 (errata-api-spm:5000)                    │  │  │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐           │  │  │
│  │  │  │/sync/usn │ │/sync/dsa │ │/sync/oval│ │/sync/nvd │           │  │  │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘           │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                     │                                        │
│                                     │ Private Endpoint                       │
│                                     ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      SUBNET-DATA (10.100.2.0/24)                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              PostgreSQL Flexible Server                          │  │  │
│  │  │              (pg-errata-test.postgres.database.azure.com)        │  │  │
│  │  │  ┌────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │                    Database: uyuni_errata                   │ │  │  │
│  │  │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐│ │  │  │
│  │  │  │ │  errata  │ │   cves   │ │ packages │ │oval_definitions  ││ │  │  │
│  │  │  │ │ 116,261  │ │  47,845  │ │ 140,937  │ │     50,862       ││ │  │  │
│  │  │  │ └──────────┘ └──────────┘ └──────────┘ └──────────────────┘│ │  │  │
│  │  │  │ ┌──────────────────────────────────────────────────────────┐│ │  │  │
│  │  │  │ │  P3 Tables: patch_tests | patch_test_metrics | events   ││ │  │  │
│  │  │  │ └──────────────────────────────────────────────────────────┘│ │  │  │
│  │  │  └────────────────────────────────────────────────────────────┘ │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │   Storage Account (Blob) - backup, OVAL files, logs            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                     │                                        │
│                                     │ VNet Peering                           │
│                                     ▼                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   SUBNET-MASTER (10.100.1.0/24)                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                INTERNAL CONTAINER (ACI)                         │  │  │
│  │  │                (10.172.5.4:5000)                                │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │  │  │
│  │  │  │/uyuni/push   │ │/uyuni/status │ │ /api/health  │            │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘            │  │  │
│  │  └──────────────────────────┬──────────────────────────────────────┘  │  │
│  │                             │ XML-RPC API (443)                        │  │
│  │                             ▼                                          │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    UYUNI SERVER (Podman)                        │  │  │
│  │  │                    (10.172.2.17)                                │  │  │
│  │  │  ┌────────────────────────────────────────────────────────────┐ │  │  │
│  │  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │ │  │  │
│  │  │  │  │ Web UI   │ │Taskomatic│ │  Salt    │ │  Cobbler     │  │ │  │  │
│  │  │  │  │  (443)   │ │  (Java)  │ │ Master   │ │  (PXE)       │  │ │  │  │
│  │  │  │  └──────────┘ └──────────┘ │(4505/06) │ └──────────────┘  │ │  │  │
│  │  │  │  ┌──────────┐ ┌──────────┐ └──────────┘ ┌──────────────┐  │ │  │  │
│  │  │  │  │ XML-RPC  │ │PostgreSQL│              │    Apache    │  │ │  │  │
│  │  │  │  │   API    │ │ (5432)   │              │   (80/443)   │  │ │  │  │
│  │  │  │  └──────────┘ └──────────┘              └──────────────┘  │ │  │  │
│  │  │  └────────────────────────────────────────────────────────────┘ │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                     │                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                 SUBNET-MANAGEMENT (10.100.3.0/24)                      │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐    │  │
│  │  │  Azure Bastion   │  │   Key Vault      │  │  Log Analytics   │    │  │
│  │  │  (Secure Access) │  │  (Credentials)   │  │   + Sentinel     │    │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     │ VNet Peering (Hub-Spoke)
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     AZURE TENANT CLIENT (SPOKE) - Per Cliente               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                  SUBNET-PROXY (10.172.1.0/24)                         │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                    UYUNI PROXY SERVER                           │  │  │
│  │  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐            │  │  │
│  │  │  │ Smart Proxy  │ │  SPM Agent   │ │ Salt Broker  │            │  │  │
│  │  │  │ (Cache Repo) │ │ (Local Sync) │ │ (4505/4506)  │            │  │  │
│  │  │  └──────────────┘ └──────────────┘ └──────────────┘            │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                     │                              │                         │
│         Salt (ZeroMQ)│                              │ Salt (ZeroMQ)          │
│                     ▼                              ▼                         │
│  ┌─────────────────────────────┐  ┌─────────────────────────────────────┐  │
│  │ SUBNET-CLIENT (10.172.2.0/24)│  │    SUBNET-TEST (10.172.3.0/24)      │  │
│  │  ┌───────────────────────┐  │  │           ISOLATED                   │  │
│  │  │   Production VMs      │  │  │  ┌───────────────────────────────┐  │  │
│  │  │  ┌─────┐ ┌─────┐     │  │  │  │      P3 Test VMs (Clones)     │  │  │
│  │  │  │ VM1 │ │ VM2 │ ... │  │  │  │  ┌─────┐                      │  │  │
│  │  │  │Salt │ │Salt │     │  │  │  │  │Clone│ ← Snapshot Source    │  │  │
│  │  │  │Minion│Minion│     │  │  │  │  │ VM  │                      │  │  │
│  │  │  └─────┘ └─────┘     │  │  │  │  └─────┘                      │  │  │
│  │  └───────────────────────┘  │  │  │  NSG: DENY ALL OUTBOUND      │  │  │
│  │                             │  │  └───────────────────────────────┘  │  │
│  └─────────────────────────────┘  └─────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. WORKFLOW FLUSSO DATI - SYNC & PUSH

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SCHEDULING (Azure Logic Apps)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │
│  │logic-usn-   │ │logic-dsa-   │ │logic-oval-  │ │logic-nvd-sync       │   │
│  │sync         │ │sync         │ │sync         │ │                     │   │
│  │Ogni 6h      │ │Daily 03:00  │ │Weekly Dom   │ │Daily 04:00          │   │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────────┬──────────┘   │
│         │               │               │                    │              │
└─────────┼───────────────┼───────────────┼────────────────────┼──────────────┘
          │               │               │                    │
          ▼               ▼               ▼                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │              PUBLIC SPM API CONTAINER                        │
    │  POST /api/sync/usn ────────────────────────────────────┐   │
    │  POST /api/sync/dsa/full ────────────────────────────┐  │   │
    │  POST /api/sync/oval ─────────────────────────────┐  │  │   │
    │  POST /api/sync/nvd ───────────────────────────┐  │  │  │   │
    │                                                │  │  │  │   │
    │  ┌──────────────────────────────────────────┐  │  │  │  │   │
    │  │           SYNC ENGINE                    │  │  │  │  │   │
    │  │  ┌────────┐ ┌────────┐ ┌──────────────┐ │  │  │  │  │   │
    │  │  │ Parser │→│Enricher│→│ DB Writer    │ │  │  │  │  │   │
    │  │  │(Source)│ │ (NVD)  │ │(PostgreSQL)  │ │◄─┴──┴──┴──┘   │
    │  │  └────────┘ └────────┘ └──────────────┘ │              │
    │  └──────────────────────────────────────────┘              │
    └──────────────────────────────────────────────────────────────┘
                                    │
                                    │ Private Endpoint
                                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                    PostgreSQL DATABASE                        │
    │  ┌──────────────────────────────────────────────────────┐   │
    │  │ errata ←──→ errata_cve ←──→ cves ←──→ nvd_enrichment│   │
    │  │    ↓                                                  │   │
    │  │ packages ←──→ oval_definitions                       │   │
    │  └──────────────────────────────────────────────────────┘   │
    └──────────────────────────────────────────────────────────────┘
                                    │
                                    │ Query
                                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │              INTERNAL SPM API CONTAINER                       │
    │  ┌──────────────────────────────────────────────────────┐   │
    │  │              UYUNI PUSH ENGINE                        │   │
    │  │  ┌────────────┐ ┌────────────┐ ┌────────────────┐   │   │
    │  │  │Query Errata│→│Format      │→│XML-RPC Push    │   │   │
    │  │  │(pending)   │ │for UYUNI   │ │to UYUNI        │   │   │
    │  │  └────────────┘ └────────────┘ └────────────────┘   │   │
    │  └──────────────────────────────────────────────────────┘   │
    │                                                              │
    │  CRON: errata-push.sh (00:30, 06:30, 12:30, 18:30)          │
    └──────────────────────────────────────────────────────────────┘
                                    │
                                    │ XML-RPC API (443)
                                    ▼
    ┌──────────────────────────────────────────────────────────────┐
    │                      UYUNI SERVER                             │
    │  ┌──────────────────────────────────────────────────────┐   │
    │  │                 ERRATA MANAGEMENT                     │   │
    │  │  ┌────────────┐ ┌────────────┐ ┌────────────────┐   │   │
    │  │  │errata.     │→│errata.     │→│Schedule        │   │   │
    │  │  │create()    │ │publish()   │ │Actions         │   │   │
    │  │  └────────────┘ └────────────┘ └────────────────┘   │   │
    │  │         ↓                             ↓              │   │
    │  │  ┌────────────────────────────────────────────┐     │   │
    │  │  │            SOFTWARE CHANNELS               │     │   │
    │  │  │  ubuntu-2404-amd64-main-security-uyuni    │     │   │
    │  │  │  ubuntu-2404-amd64-universe-security-uyuni│     │   │
    │  │  └────────────────────────────────────────────┘     │   │
    │  └──────────────────────────────────────────────────────┘   │
    └──────────────────────────────────────────────────────────────┘
```

---

## 3. PROCESSO P1-P5 COMPLETO

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SECURITY PATCH MANAGEMENT LIFECYCLE                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│      P1      │───▶│      P2      │───▶│      P3      │───▶│      P4      │───▶│      P5      │
│   DISCOVERY  │    │ PRIORITIZE   │    │   TESTING    │    │   DEPLOY     │    │  ASSESSMENT  │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
       │                   │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ • Inventario │    │ • Sync USN   │    │ • Snapshot   │    │ • Salt State │    │ • Re-scan    │
│   VM         │    │ • Sync DSA   │    │   Source VM  │    │   Apply      │    │   OVAL       │
│ • OS Version │    │ • Sync OVAL  │    │ • Clone to   │    │ • Rolling    │    │ • Verify     │
│ • Packages   │    │ • Sync NVD   │    │   Test Subnet│    │   Update     │    │   Patched    │
│ • Services   │    │ • CVSS Score │    │ • Baseline   │    │ • Maintenance│    │ • Compliance │
│ • Groups     │    │ • Risk Level │    │   Metrics    │    │   Windows    │    │   Report     │
│              │    │ • Smart Mode │    │ • Apply Patch│    │ • Rollback   │    │              │
│              │    │   vs Security│    │ • Post-Patch │    │   if Fail    │    │              │
│              │    │   Mode       │    │   Metrics    │    │              │    │              │
│              │    │              │    │ • Evaluate   │    │              │    │              │
│              │    │              │    │   Pass/Fail  │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
       │                   │                   │                   │                   │
       │                   │                   │                   │                   │
       ▼                   ▼                   ▼                   ▼                   ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   UYUNI      │    │  PostgreSQL  │    │  Azure SDK   │    │    Salt      │    │    OVAL      │
│ system.*     │    │   Database   │    │  + Salt      │    │  state.apply │    │   Audit      │
│ channel.*    │    │              │    │              │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘
```

---

## 4. P3 PATCH TESTING - DETTAGLIO

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        P3 PATCH TESTING WORKFLOW                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│    SOURCE VM         │
│  (Production)        │
│  Subnet-Client       │
└──────────┬───────────┘
           │
           │ 1. Create Snapshot
           ▼
┌──────────────────────┐
│   Azure Snapshot     │
│   (Managed Disk)     │
└──────────┬───────────┘
           │
           │ 2. Create VM from Snapshot
           ▼
┌──────────────────────────────────────────────────────────────────┐
│                    SUBNET-TEST (ISOLATED)                         │
│                    NSG: DENY ALL OUTBOUND                         │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │                     TEST VM (Clone)                         │  │
│  │                                                             │  │
│  │  3. BASELINE COLLECTION                                     │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ • CPU: avg%, max%                                     │  │  │
│  │  │ • Memory: usage%                                      │  │  │
│  │  │ • Disk I/O: read/write MB/s                          │  │  │
│  │  │ • Network: connections, bytes in/out                 │  │  │
│  │  │ • Services: running list, failed list                │  │  │
│  │  │ • Custom checks: application health                  │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  │                          │                                  │  │
│  │                          ▼                                  │  │
│  │  4. APPLY PATCH (Salt state.apply)                         │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ salt-call state.apply patch.install                  │  │  │
│  │  │ pillar='{"errata_id": "USN-7654-1"}'                 │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  │                          │                                  │  │
│  │                          ▼                                  │  │
│  │  5. POST-PATCH COLLECTION                                  │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ (Same metrics as baseline)                           │  │  │
│  │  │ + Service health check                               │  │  │
│  │  │ + Application smoke tests                            │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  │                          │                                  │  │
│  │                          ▼                                  │  │
│  │  6. EVALUATION                                              │  │
│  │  ┌──────────────────────────────────────────────────────┐  │  │
│  │  │ Compare: baseline vs post-patch                      │  │  │
│  │  │ Thresholds:                                          │  │  │
│  │  │  - CPU delta < 10%                                   │  │  │
│  │  │  - Memory delta < 15%                                │  │  │
│  │  │  - All critical services running                     │  │  │
│  │  │  - No new failed services                            │  │  │
│  │  └──────────────────────────────────────────────────────┘  │  │
│  │                          │                                  │  │
│  └──────────────────────────┼──────────────────────────────────┘  │
│                             │                                      │
└─────────────────────────────┼──────────────────────────────────────┘
                              │
                              ▼
                 ┌───────────────────────┐
                 │      DECISION         │
                 └───────────┬───────────┘
                             │
            ┌────────────────┴────────────────┐
            │                                 │
            ▼                                 ▼
   ┌─────────────────┐               ┌─────────────────┐
   │   ✓ PASSED      │               │   ✗ FAILED      │
   │   → P4 Deploy   │               │   → Review      │
   │   to Production │               │   Manual        │
   └─────────────────┘               └─────────────────┘
            │                                 │
            │ 7. CLEANUP                      │
            ▼                                 ▼
   ┌─────────────────────────────────────────────────┐
   │  • Delete Test VM                               │
   │  • Delete Snapshot (optional)                   │
   │  • Archive test logs to Storage Account         │
   │  • Update patch_tests table with result         │
   └─────────────────────────────────────────────────┘
```

---

## 5. INTERFACCE API - DETTAGLIO

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API INTERFACES                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                     SPM API v2.6 (Flask/Gunicorn)                           │
│  Endpoint: errata-api-spm.italynorth.azurecontainer.io:5000                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SYNC ENDPOINTS (Public Container)                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ POST /api/sync/usn                                                     │ │
│  │   └─ Params: none                                                      │ │
│  │   └─ Source: ubuntu.com/security/notices/rss.xml                       │ │
│  │   └─ Returns: {"synced": 15, "errors": 0}                             │ │
│  │                                                                        │ │
│  │ POST /api/sync/dsa/full                                               │ │
│  │   └─ Params: none                                                      │ │
│  │   └─ Source: security-tracker.debian.org                               │ │
│  │   └─ Timeout: 30 min                                                   │ │
│  │   └─ Returns: {"synced": 115678, "errors": 0}                         │ │
│  │                                                                        │ │
│  │ POST /api/sync/oval                                                    │ │
│  │   └─ Params: platform (ubuntu|debian|all)                             │ │
│  │   └─ Source: security-metadata.canonical.com, debian.org/security/oval │ │
│  │   └─ Timeout: 60 min                                                   │ │
│  │   └─ Returns: {"ubuntu": 5359, "debian": 45503}                       │ │
│  │                                                                        │ │
│  │ POST /api/sync/nvd                                                     │ │
│  │   └─ Params: batch_size (default 200)                                 │ │
│  │   └─ Source: services.nvd.nist.gov/rest/json/cves/2.0                 │ │
│  │   └─ Rate: 0.6s between requests (with API key)                       │ │
│  │   └─ Returns: {"enriched": 228, "errors": 0}                          │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  HEALTH ENDPOINTS                                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ GET /api/health                                                        │ │
│  │   └─ Returns: {"status": "healthy"}                                   │ │
│  │                                                                        │ │
│  │ GET /api/health/detailed                                              │ │
│  │   └─ Returns: {"db": "ok", "errata": 116261, "cves": 47845}          │ │
│  │                                                                        │ │
│  │ GET /api/stats/overview                                               │ │
│  │   └─ Returns: full database statistics                                │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  UYUNI ENDPOINTS (Internal Container Only)                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ GET /api/uyuni/status                                                  │ │
│  │   └─ Returns: {"connected": true, "version": "2024.05"}              │ │
│  │                                                                        │ │
│  │ POST /api/uyuni/push                                                   │ │
│  │   └─ Params: limit (default 100), dry_run (default false)            │ │
│  │   └─ Action: Push pending errata to UYUNI via XML-RPC                │ │
│  │   └─ Returns: {"pushed": 45, "failed": 2}                            │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                     UYUNI XML-RPC API                                        │
│  Endpoint: https://uyuni-server:443/rpc/api                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  AUTH NAMESPACE                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ auth.login(username, password) → session_key                          │ │
│  │ auth.logout(session_key)                                              │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ERRATA NAMESPACE                                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ errata.create(session, errata_info, bugs, keywords, packages, chans)  │ │
│  │ errata.publish(session, errata_id, [channel_label])                   │ │
│  │ errata.listAffectedSystems(session, errata_id)                        │ │
│  │ errata.getDetails(session, errata_id)                                 │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  SYSTEM NAMESPACE                                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ system.listSystems(session)                                           │ │
│  │ system.getDetails(session, system_id)                                 │ │
│  │ system.scheduleApplyErrata(session, system_id, errata_ids, date)     │ │
│  │ system.listRelevantErrata(session, system_id)                        │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  CHANNEL NAMESPACE                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ channel.software.listChildren(session, channel_label)                 │ │
│  │ channel.software.listAllPackages(session, channel_label)             │ │
│  │ channel.software.syncErrata(session, channel_label)                  │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  SCHEDULE NAMESPACE                                                         │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ schedule.listInProgressSystems(session, action_id)                    │ │
│  │ schedule.listCompletedSystems(session, action_id)                    │ │
│  │ schedule.listFailedSystems(session, action_id)                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. NETWORK SECURITY ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NETWORK SECURITY GROUPS (NSG)                             │
└─────────────────────────────────────────────────────────────────────────────┘

INTERNET ────────────────────────────────────────────────────────────────────
    │
    │ HTTPS (443)
    ▼
┌─────────────────────────────────────────────────┐
│              AZURE FIREWALL                      │
│  Rules:                                          │
│  - Allow 443 to SPM Public Container            │
│  - Allow 443 to USN/DSA/NVD sources             │
│  - Log all traffic                              │
└─────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────┐
│           NSG-PUBLIC-CONTAINER                   │
│  Inbound:                                        │
│  - 443 from Internet (Logic Apps)               │
│  - 5000 from Internal VNET                      │
│  Outbound:                                       │
│  - 443 to Internet (USN, DSA, NVD)              │
│  - 5432 to PostgreSQL                           │
└─────────────────────────────────────────────────┘
    │
    │ Private Endpoint (5432)
    ▼
┌─────────────────────────────────────────────────┐
│              NSG-DATA                            │
│  Inbound:                                        │
│  - 5432 from Public Container                   │
│  - 5432 from Internal Container                 │
│  - 5432 from UYUNI Server                       │
│  Outbound:                                       │
│  - DENY ALL                                     │
└─────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────┐
│           NSG-MASTER                             │
│  Inbound:                                        │
│  - 443, 5000 from Proxy Servers                 │
│  - 22 from Azure Bastion                        │
│  Outbound:                                       │
│  - 443 to Internet (SUSE repos)                 │
│  - 5432 to PostgreSQL                           │
│  - 4505, 4506 to Proxy                          │
└─────────────────────────────────────────────────┘
    │
    │ VNet Peering
    ▼
┌─────────────────────────────────────────────────┐
│              NSG-PROXY                           │
│  Inbound:                                        │
│  - 443 from Master                              │
│  - 4505, 4506 from Master (Salt)               │
│  - 22 from Bastion                              │
│  Outbound:                                       │
│  - 22, 4505, 4506 to Client VMs                │
│  - 443 to Master                                │
└─────────────────────────────────────────────────┘
    │
    ├─────────────────┬─────────────────┐
    │                 │                 │
    ▼                 ▼                 ▼
┌───────────┐  ┌───────────┐  ┌─────────────────────┐
│NSG-CLIENT │  │NSG-CLIENT │  │     NSG-TEST        │
│  Inbound: │  │ VM 2      │  │  Inbound:           │
│  - 22 from│  │           │  │  - 22 from Proxy    │
│    Proxy  │  │           │  │  Outbound:          │
│  Outbound:│  │           │  │  - DENY ALL         │
│  - 80,443 │  │           │  │  (Completely        │
│    to Repo│  │           │  │   Isolated)         │
└───────────┘  └───────────┘  └─────────────────────┘
```

---

## 7. DATABASE SCHEMA OVERVIEW

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PostgreSQL DATABASE SCHEMA                                │
│                    Database: uyuni_errata                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐
│      errata       │       │    errata_cve     │       │       cves        │
├───────────────────┤       ├───────────────────┤       ├───────────────────┤
│ PK errata_id      │───┐   │ FK errata_id      │   ┌───│ PK cve_id         │
│    advisory_name  │   └──▶│ FK cve_id         │◀──┘   │    cvss_score     │
│    synopsis       │       └───────────────────┘       │    cvss_vector    │
│    description    │                                    │    severity       │
│    severity       │                                    │    nvd_enriched   │
│    issue_date     │                                    │    published_date │
│    pushed_to_uyuni│                                    └───────────────────┘
│    source (USN/DSA│                                            │
└────────┬──────────┘                                            │
         │                                                       │
         │                                                       │
         ▼                                                       ▼
┌───────────────────┐                               ┌───────────────────────┐
│     packages      │                               │   oval_definitions    │
├───────────────────┤                               ├───────────────────────┤
│ PK package_id     │                               │ PK oval_id            │
│ FK errata_id      │                               │    cve_ref            │
│    package_name   │                               │    platform           │
│    version        │                               │    criteria           │
│    architecture   │                               │    affected_version   │
│    channel_label  │                               │    status             │
└───────────────────┘                               └───────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────┐
│                         P3 TESTING TABLES                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────────────┐     ┌─────────────────────────┐
│      patch_tests      │     │   patch_test_metrics    │
├───────────────────────┤     ├─────────────────────────┤
│ PK id                 │────▶│ FK test_id              │
│ FK errata_id          │     │    phase (baseline/     │
│ FK source_system_id   │     │           post_patch)   │
│    clone_vm_id        │     │    cpu_usage_avg        │
│    status             │     │    cpu_usage_max        │
│    created_at         │     │    memory_usage_percent │
│    started_at         │     │    disk_io_read_mbps    │
│    completed_at       │     │    disk_io_write_mbps   │
│    test_report (JSON) │     │    network_connections  │
└───────────────────────┘     │    services_running     │
         │                    │    services_failed      │
         │                    │    services_list (JSON) │
         ▼                    │    custom_checks (JSON) │
┌───────────────────────┐     └─────────────────────────┘
│   patch_test_events   │
├───────────────────────┤
│ PK id                 │
│ FK test_id            │
│    timestamp          │
│    event_type         │
│    event_details      │
│    severity           │
└───────────────────────┘


STATISTICS (2026-01-31):
┌────────────────────────┬────────────┐
│ Table                  │ Records    │
├────────────────────────┼────────────┤
│ errata                 │ 116,261    │
│ cves                   │  47,845    │
│ packages               │ 140,937    │
│ oval_definitions       │  50,862    │
└────────────────────────┴────────────┘
```

---

## 8. SCHEDULING TIMELINE

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    DAILY SCHEDULING TIMELINE                                 │
└─────────────────────────────────────────────────────────────────────────────┘

00:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  │
  ├─ 00:30  ┌─────────────────────────────────────┐
  │         │ CRON: errata-push.sh                │
  │         │ Push pending errata to UYUNI        │
  │         └─────────────────────────────────────┘
  │
  ├─ 01:00  ┌─────────────────────────────────────┐
  │         │ CRON: sync-channels.sh              │
  │         │ Sync UYUNI channels from repos      │
  │         └─────────────────────────────────────┘
  │
  ├─ 02:00  ┌─────────────────────────────────────┐  (Solo Domenica)
  │         │ LOGIC APP: logic-oval-sync          │
  │         │ POST /api/sync/oval?platform=all    │
  │         │ Timeout: 60 min                     │
  │         └─────────────────────────────────────┘
  │
  ├─ 03:00  ┌─────────────────────────────────────┐
  │         │ LOGIC APP: logic-dsa-sync           │
  │         │ POST /api/sync/dsa/full             │
  │         │ Timeout: 30 min                     │
  │         └─────────────────────────────────────┘
  │
  ├─ 04:00  ┌─────────────────────────────────────┐
  │         │ LOGIC APP: logic-nvd-sync           │
  │         │ POST /api/sync/nvd?batch_size=200   │
  │         │ Timeout: 30 min                     │
  │         └─────────────────────────────────────┘
  │
06:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  │
  ├─ 06:00  ┌─────────────────────────────────────┐
  │         │ LOGIC APP: logic-usn-sync           │
  │         │ POST /api/sync/usn                  │
  │         └─────────────────────────────────────┘
  │
  ├─ 06:30  ┌─────────────────────────────────────┐
  │         │ CRON: errata-push.sh                │
  │         └─────────────────────────────────────┘
  │
12:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  │
  ├─ 12:00  ┌─────────────────────────────────────┐
  │         │ LOGIC APP: logic-usn-sync           │
  │         └─────────────────────────────────────┘
  │
  ├─ 12:30  ┌─────────────────────────────────────┐
  │         │ CRON: errata-push.sh                │
  │         └─────────────────────────────────────┘
  │
18:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  │
  ├─ 18:00  ┌─────────────────────────────────────┐
  │         │ LOGIC APP: logic-usn-sync           │
  │         └─────────────────────────────────────┘
  │
  ├─ 18:30  ┌─────────────────────────────────────┐
  │         │ CRON: errata-push.sh                │
  │         └─────────────────────────────────────┘
  │
24:00 ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

LEGEND:
━━━━━━━  Timeline
┌─────┐  Scheduled Job
CRON     Server-side cron job
LOGIC    Azure Logic App trigger
```

---

## 9. TECHNOLOGY STACK SUMMARY

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TECHNOLOGY STACK                                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┬────────────────────────────────────────────────────────────┐
│    LAYER        │                      COMPONENTS                            │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Azure Logic Apps (Scheduling)                             │
│  ORCHESTRATION  │  Azure Container Instances (SPM API)                       │
│                 │  Cron Jobs (UYUNI Server)                                  │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Flask 3.0 + Gunicorn (REST API)                          │
│  APPLICATION    │  UYUNI 2024.05 (Patch Management)                         │
│                 │  n8n (Workflow Automation)                                 │
│                 │  Groq AI (LLM for Service Remediation)                    │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Salt (Configuration Management)                           │
│  CONFIG MGMT    │  Salt Master (UYUNI integrated)                           │
│                 │  Salt Minion (Client agents)                              │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  PostgreSQL 14 (Azure Flexible Server)                    │
│  DATABASE       │  PostgreSQL (UYUNI internal)                              │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Podman (UYUNI containerized)                             │
│  CONTAINERS     │  Docker (n8n, SPM API local dev)                          │
│                 │  Azure Container Instances (Production)                    │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Azure Virtual Network (Hub-Spoke)                        │
│  NETWORK        │  Azure Firewall Premium                                    │
│                 │  Network Security Groups                                   │
│                 │  Private Endpoints                                         │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Azure Key Vault (Secrets)                                │
│  SECURITY       │  Azure Bastion (Secure Access)                            │
│                 │  Microsoft Defender for Cloud                             │
│                 │  Microsoft Sentinel (SIEM)                                │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Azure Storage Account (Blobs)                            │
│  STORAGE        │  Azure Managed Disks (VM)                                 │
│                 │  Azure Snapshots (P3 Testing)                             │
├─────────────────┼────────────────────────────────────────────────────────────┤
│                 │  Log Analytics Workspace                                   │
│  MONITORING     │  Azure Monitor                                             │
│                 │  Application Insights                                      │
└─────────────────┴────────────────────────────────────────────────────────────┘

SUPPORTED CLIENT OS:
┌────────────────────────┬─────────┬─────────┐
│ Operating System       │ x86-64  │ aarch64 │
├────────────────────────┼─────────┼─────────┤
│ Ubuntu 24.04/22.04     │   ✓     │    -    │
│ Debian 12              │   ✓     │    -    │
│ RHEL 9/8               │   ✓     │   ✓     │
│ AlmaLinux 9/8          │   ✓     │   ✓     │
│ Rocky Linux 9/8        │   ✓     │   ✓     │
│ Oracle Linux 9/8/7     │   ✓     │   ✓     │
│ SUSE Linux Enterprise  │   ✓     │   ✓     │
└────────────────────────┴─────────┴─────────┘
```

---

## 10. DIAGRAMMI DRAWIO DETTAGLIATI

I seguenti diagrammi sono disponibili in formato draw.io per una visualizzazione interattiva:

| Diagramma | File | Descrizione |
|-----------|------|-------------|
| **Flask API Architecture** | `SPM-Flask-API-Architecture.drawio` | Struttura completa dell'API Flask v2.6, endpoint map, configurazione, flusso richieste |
| **Sync Workflow** | `SPM-Sync-Workflow.drawio` | Flusso dettagliato sincronizzazione dati (USN, DSA, NVD, OVAL) con timeline scheduling |
| **Push to UYUNI** | `SPM-Push-UYUNI-Workflow.drawio` | Workflow completo push errata verso UYUNI con version matching [FIX #1] |
| **Database Schema** | `SPM-Database-Schema.drawio` | Entity-Relationship diagram con tutte le tabelle e relazioni |
| **Infrastructure LLD** | `SPM-Architecture.drawio` | Architettura Azure Hub-Spoke con tutti i componenti di rete |
| **Current Infrastructure** | `SPM-Current-Infrastructure.drawio` | Stato attuale dell'infrastruttura deployata |

**Percorso file:** `/mnt/c/Users/alber/Documents/GitHub/Security-Patch-Manager/Uyuni/Infrastructure-Design/`

---

*Documento generato: 2026-02-03*
*Versione: 1.1*
